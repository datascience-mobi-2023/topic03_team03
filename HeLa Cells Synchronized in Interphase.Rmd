---
title: "Topic 3: Proteome-wide Screen for RNA-dependent Proteins; Subtopic 3: HeLa synchronized in Interphase"
author: "Hannah, Johann, Kira, Viktor"
date: "2023-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Topic 3: Proteome-wide Screen for RNA-dependent Proteins

#### Subtopic 3: HeLa Cells Synchronized in Interphase

First, we will load the dataset containing the mass spectrometry data from HeLa cells synchronized in interphase:

```{r}
RDeeP_HeLa_Interphase = read.csv("https://www.dropbox.com/s/nm9bgsyg7cv6wu1/RDeeP_HeLa_Interphase.csv?dl=1", header=TRUE, row.names=1, sep = ";")
head(RDeeP_HeLa_Interphase)
```

Are there any missing values in the dataset?

```{r}
sum(is.na(RDeeP_HeLa_Interphase))
```

Are there any rows that only contain zeros?

```{r}
which(rowSums(RDeeP_HeLa_Interphase)==0)
```

#### 1.1 Split Dataset into Control and RNase

We can also split the dataset into two seperate datasets that contain the Control and RNase values:

```{r}
RDeeP_HeLa_Interphase_Ctrl = as.data.frame(
                             # Diese Matrix speichern wir noch als Dataframe
  matrix(
  # Aus dem großen Vektor, den wir mit "unlist" erstellt haben (mit 531450 Einträgen), machen wir eine Matrix mit      7086 Zeilen und 75 Spalten
    
    unlist(
    # Da die untere Schleife einen Dataframe erstellt mit 75 Spalten und drei Zeilen (jede Zelle enthält einen           Vektor, der einer Spalte im originalen Dataframe entspricht), müssen wir aus diesem Dataframe einen einzigen         großen Vektor mit allen Proteineinträgen generieren (das macht der Befehl "unlist")
      
      sapply(seq(0,144,6), function(n) {RDeeP_HeLa_Interphase[,c(1,2,3)+c(n,n,n)]})), 
      # Schleife, die alle Spalten der Control Samples aus dem Dataframe "RDeep_HeLa_Interphase" in Dreier-Grüppchen       (jeweils die drei Replikate pro Fraktion) nacheinander auswählt
    
    nrow=7086, ncol=75))

# Hier werden dem neu erstellten Control Dataframe die Zeilen und Spaltennamen des originalen Dataframes zugeordnet (nutzt die gleiche Schleife zum Auswählen der Control Spalten wie oben)
colnames(RDeeP_HeLa_Interphase_Ctrl) = as.vector(unlist(sapply(seq(0,144,6), function(n) {colnames(RDeeP_HeLa_Interphase[,c(1,2,3)+c(n,n,n)])})))

rownames(RDeeP_HeLa_Interphase_Ctrl) = rownames(RDeeP_HeLa_Interphase)

# Analoges Vorgehen für RNase wie Control, nur, dass sich die Startposition zum Auswählen verändert
RDeeP_HeLa_Interphase_RNase = as.data.frame(matrix(unlist(sapply(seq(0,144,6), function(n) {RDeeP_HeLa_Interphase[,c(4,5,6)+c(n,n,n)]})), nrow=7086, ncol=75))

colnames(RDeeP_HeLa_Interphase_RNase) = as.vector(unlist(sapply(seq(0,144,6), function(n) {colnames(RDeeP_HeLa_Interphase[,c(4,5,6)+c(n,n,n)])})))

rownames(RDeeP_HeLa_Interphase_RNase) = rownames(RDeeP_HeLa_Interphase)
```

#### 1.2 NA Values and Zero Rows
```{r}
## Überprüfen welche Reihen in den Datasets nur Nullen enthalten

which(rowSums(RDeeP_HeLa_Interphase_Ctrl)==0)
which(rowSums(RDeeP_HeLa_Interphase_RNase)==0)

## Löschen der Nullreihen im Controldataset

RDeeP_HeLa_Interphase_Ctrl <- RDeeP_HeLa_Interphase_Ctrl[!(rownames(RDeeP_HeLa_Interphase_Ctrl)%in% c("FHOD3_HUMAN","P210L_HUMAN","PKD1_HUMAN","TGM7_HUMAN","KIF1A_HUMAN")),]

##Löschen der Nullreihen im RNase-Dataset

RDeeP_HeLa_Interphase_RNase <- RDeeP_HeLa_Interphase_RNase[!(rownames(RDeeP_HeLa_Interphase_RNase) %in% c("FHOD3_HUMAN","P210L_HUMAN","PKD1_HUMAN","TGM7_HUMAN", "KIF1A_HUMAN")),]
```

#### 1.4 Mean of Replicates

```{r}
Mean_Ctrl = as.data.frame(
            # Abspeichern als Dataframe
  
  sapply(seq(0,72,3), function(i) {
  # Äußere Schleife, die zum Auswählen der drei Replikate pro Fraktion da ist (Startvektor c(1,2,3) wird jeweils um c(3,3,3) erhöht) 
    
    apply(RDeeP_HeLa_Interphase_Ctrl[,c(1,2,3)+c(i,i,i)], 1, function(x) {mean(x)})
    # Innere Schleife, die nachdem die drei Replikate für eine Fraktion ausgewählt wurden, über alle Zeilen dieser       Replikate den Mittelwert berechnet
    
    }))

# Erstellen neuer Spaltennamen für den Mean_Ctrl Dataframe. Der Befehl "paste" erlaubt es, sowohl Text als auch Befehle als ein String zu haben (sep="", bedeutet, dass die Elemente durch kein Leerzeichen voneinander getrennt werden sollen)
colnames(Mean_Ctrl) = paste("Fraction",seq(1,25,1),"_Ctrl_Mean",sep="")

# Analoges Vorgehen für den RNase Dataframe
Mean_RNase = as.data.frame(
  sapply(seq(0,72,3), function(i) {
    apply(RDeeP_HeLa_Interphase_RNase[,c(1,2,3)+c(i,i,i)], 1, function(x) {mean(x)})
    }))

colnames(Mean_RNase) = paste("Fraction",seq(1,25,1),"_RNase_Mean",sep="")
```


#### 1.5 Normalize Rows to 100

This will be done for the Control and RNase Datasets separately:

```{r}
Ctrl_Norm_100 = as.data.frame(sapply(RDeeP_HeLa_Interphase_Ctrl, function(i){(i/apply(RDeeP_HeLa_Interphase_Ctrl,1,sum))*100}))

RNase_Norm_100 = as.data.frame(sapply(RDeeP_HeLa_Interphase_RNase, function(i){(i/apply(RDeeP_HeLa_Interphase_RNase,1,sum))*100}))
```

#### 1.7 Data Exploration, First Graphical Representations

##### Without Normalization
```{r}
plot(1:25, Mean_Ctrl[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CTCF_HUMAN")
lines(1:25, Mean_RNase[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```
```{r}
plot(1:25, Mean_Ctrl[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CY24A_HUMAN")
lines(1:25, Mean_RNase[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```

##### With Normailzation 
```{r}
Mean_Ctrl_Norm_100 = as.data.frame(sapply(Mean_Ctrl, function(i){(i/apply(Mean_Ctrl,1,sum))*100}))

Mean_RNase_Norm_100 = as.data.frame(sapply(Mean_RNase, function(i){(i/apply(Mean_RNase,1,sum))*100}))
```

```{r}
plot(1:25, Mean_Ctrl_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CTCF_HUMAN Normalized", ylim=c(0,25))
lines(1:25, Mean_RNase_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```

```{r}
plot(1:25, Mean_Ctrl_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CY24A_HUMAN Normailzed", ylim=c(0,18))
lines(1:25, Mean_RNase_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```

### Determination of Maxima

#### 2.1 Smoothing the Data

We will smooth out the Data by calculating the mean value for each fraction within a defined neighborhood (n):
```{r}
# n = 1 (left and right neighbor)
Mean_Ctrl_Norm_100_Smooth = 
  as.data.frame(
cbind(Mean_Ctrl_Norm_100[,1],
      sapply(seq(0,22,1), function(i) {apply(Mean_Ctrl_Norm_100[,c(1,2,3)+c(i,i,i)], 1, function(x) {mean(x)})}), 
      Mean_Ctrl_Norm_100[,25])
)

colnames(Mean_Ctrl_Norm_100_Smooth) = colnames(Mean_Ctrl_Norm_100)


Mean_RNase_Norm_100_Smooth = 
  as.data.frame(
cbind(Mean_RNase_Norm_100[,1],
      sapply(seq(0,22,1), function(i) {apply(Mean_RNase_Norm_100[,c(1,2,3)+c(i,i,i)], 1, function(x) {mean(x)})}), 
      Mean_RNase_Norm_100[,25])
)

colnames(Mean_RNase_Norm_100_Smooth) = colnames(Mean_RNase_Norm_100)
```

Now let us explore how this smoothing effects the data distribution:
```{r}
plot(1:25, Mean_Ctrl_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CTCF_HUMAN Normalized", ylim=c(0,25))
lines(1:25, Mean_RNase_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)

plot(1:25, Mean_Ctrl_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CTCF_HUMAN Normalized and Smoothed", ylim=c(0,25))
lines(1:25, Mean_RNase_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==c("CTCF_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```

```{r}
plot(1:25, Mean_Ctrl_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CY24A_HUMAN Normailzed", ylim=c(0,18))
lines(1:25, Mean_RNase_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)

plot(1:25, Mean_Ctrl_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main="CY24A_HUMAN Normailzed and Smoothed", ylim=c(0,18))
lines(1:25, Mean_RNase_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==c("CY24A_HUMAN")),], type="l",lwd=3,col="red")
grid()
legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
```

#### 2.2 Determination of Global and Local Maxima

Let us first start with the global maxima: we want a code that tells us the global maximum fraction position for each gene and condition (Control and RNase)
```{r}
Mean_Ctrl_Gbl_Max = as.matrix(sapply(seq(1,7081,1),function(i) {which(Mean_Ctrl_Norm_100_Smooth[i,] == max(Mean_Ctrl_Norm_100_Smooth[i,]))}))

# If 2 fraction positions contain the maximum protein amount, we determine the mean of these 2 fraction positions
Mean_Ctrl_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_Ctrl_Norm_100_Smooth[i,] == max(Mean_Ctrl_Norm_100_Smooth[i,]) ))}) == 2),1] = apply(matrix(unlist(Mean_Ctrl_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_Ctrl_Norm_100_Smooth[i,] == max(Mean_Ctrl_Norm_100_Smooth[i,]) ))}) == 2),1]), ncol=2, byrow=T), 1, function(x) {mean(x)})

# If 3 fraction positions contain the maximum protein amount, we determine the mean of these 3 fraction positions
Mean_Ctrl_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_Ctrl_Norm_100_Smooth[i,] == max(Mean_Ctrl_Norm_100_Smooth[i,]) ))}) == 3),1] = apply(matrix(unlist(Mean_Ctrl_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_Ctrl_Norm_100_Smooth[i,] == max(Mean_Ctrl_Norm_100_Smooth[i,]) ))}) == 3),1]), ncol=3, byrow=T), 1, function(x) {mean(x)})

colnames(Mean_Ctrl_Gbl_Max) = c("Gbl_Max")
rownames(Mean_Ctrl_Gbl_Max) = rownames(Mean_Ctrl_Norm_100_Smooth)



Mean_RNase_Gbl_Max = as.matrix(sapply(seq(1,7081,1),function(i) {which(Mean_RNase_Norm_100_Smooth[i,] == max(Mean_RNase_Norm_100_Smooth[i,]))}))

Mean_RNase_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_RNase_Norm_100_Smooth[i,] == max(Mean_RNase_Norm_100_Smooth[i,]) ))}) == 2),1] = apply(matrix(unlist(Mean_RNase_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_RNase_Norm_100_Smooth[i,] == max(Mean_RNase_Norm_100_Smooth[i,]) ))}) == 2),1]), ncol=2, byrow=T), 1, function(x) {mean(x)})

Mean_RNase_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_RNase_Norm_100_Smooth[i,] == max(Mean_RNase_Norm_100_Smooth[i,]) ))}) == 3),1] = apply(matrix(unlist(Mean_RNase_Gbl_Max[which(sapply(seq(1,7081,1),function(i) {length(which(Mean_RNase_Norm_100_Smooth[i,] == max(Mean_RNase_Norm_100_Smooth[i,]) ))}) == 3),1]), ncol=3, byrow=T), 1, function(x) {mean(x)})

colnames(Mean_RNase_Gbl_Max) = c("Gbl_Max")
rownames(Mean_RNase_Gbl_Max) = rownames(Mean_RNase_Norm_100_Smooth)
```

Lets see if it worked!


```{r}
gene.name=c("CTCF_HUMAN")

plot(1:25, Mean_Ctrl_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main=paste(paste(gene.name, "(Normalized and Smoothed)")), ylim=c(0,25))

abline(v=Mean_Ctrl_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="green",lty=3)

lines(1:25, Mean_RNase_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),], type="l",lwd=3,col="red")

abline(v=Mean_RNase_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="red",lty=3)

grid()

legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
rm(gene.name)
```


```{r}
gene.name=c("CY24A_HUMAN")

plot(1:25, Mean_Ctrl_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main=paste(paste(gene.name, "(Normalized and Smoothed)")), ylim=c(0,25))

abline(v=Mean_Ctrl_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="green",lty=3)

lines(1:25, Mean_RNase_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),], type="l",lwd=3,col="red")

abline(v=Mean_RNase_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="red",lty=3)

grid()

legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
rm(gene.name)
```

```{r}
gene.name=c("RS29_HUMAN")

plot(1:25, Mean_Ctrl_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main=paste(paste(gene.name, "(Normalized and Smoothed)")), ylim=c(0,25))

abline(v=Mean_Ctrl_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="green",lty=3)

lines(1:25, Mean_RNase_Norm_100_Smooth[which(rownames(RDeeP_HeLa_Interphase)==gene.name),], type="l",lwd=3,col="red")

abline(v=Mean_RNase_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="red",lty=3)

grid()

legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)


plot(1:25, Mean_Ctrl_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],type="l",lwd=3,col="green",xlab="Fractions",ylab="Relative Protein Amount",main=paste(paste(gene.name, "(Normalized and Smoothed)")), ylim=c(0,25))

abline(v=Mean_Ctrl_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="green",lty=3)

lines(1:25, Mean_RNase_Norm_100[which(rownames(RDeeP_HeLa_Interphase)==gene.name),], type="l",lwd=3,col="red")

abline(v=Mean_RNase_Gbl_Max[which(rownames(RDeeP_HeLa_Interphase)==gene.name),],lwd=3,col="red",lty=3)

grid()

legend("topright",legend=c("Control","RNase"),col=c("green","red"),bg="white",lwd=2)
rm(gene.name)
```

